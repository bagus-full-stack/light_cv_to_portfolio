<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G√©n√©rateur de Portfolio (S√©lecteur de Mod√®les)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --light: #ecf0f1; --success: #27ae60; --danger: #e74c3c; }
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; color: #333; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .card { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 500px; text-align: center; }
        h1 { color: var(--primary); margin-bottom: 10px; font-size: 1.8rem; }
        p { color: #666; margin-bottom: 30px; font-size: 0.9rem; }
        .input-group { margin-bottom: 15px; text-align: left; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: var(--primary); font-size: 0.9rem; }
        input[type="text"], input[type="password"], select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; outline: none; }
        input:focus, select:focus { border-color: var(--accent); }
        .row { display: flex; gap: 10px; align-items: flex-end; }
        .btn-small { padding: 12px; background: #666; color: white; border: none; border-radius: 6px; cursor: pointer; white-space: nowrap; }
        .btn-small:hover { background: var(--accent); }
        .file-drop { border: 2px dashed var(--accent); padding: 30px; border-radius: 8px; cursor: pointer; transition: 0.3s; background: #f9fbff; margin-top: 20px; }
        .file-drop:hover { background: #eef5ff; border-color: var(--primary); }
        .btn { background: var(--accent); color: white; border: none; padding: 12px 25px; border-radius: 30px; font-size: 1rem; cursor: pointer; width: 100%; margin-top: 20px; transition: 0.3s; font-weight: bold; }
        .btn:hover { background: var(--primary); }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .status { margin-top: 20px; font-size: 0.9rem; min-height: 20px; font-weight: 500; }
        .success { color: var(--success); }
        .error { color: var(--danger); }
        .hidden { display: none; }
        .logo-ai { display: inline-block; background: linear-gradient(45deg, #4285F4, #9B72CB); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: bold; }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
</head>
<body>

    <div class="card">
        <h1>üöÄ G√©n√©rateur <span class="logo-ai">Gemini</span></h1>
        
        <div id="login-section">
            <p>Connectez-vous pour acc√©der au g√©n√©rateur.</p>
            <div class="input-group">
                <label>Email Admin</label>
                <input type="text" id="email" placeholder="admin@exemple.com">
            </div>
            <div class="input-group">
                <label>Mot de passe</label>
                <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <button class="btn" id="login-btn">Se connecter</button>
        </div>

        <div id="upload-section" class="hidden">
            
            <div class="input-group">
                <label>Cl√© API Google Gemini</label>
                <div class="row">
                    <input type="password" id="gemini-key" placeholder="AIza...">
                    <button class="btn-small" id="load-models-btn" title="V√©rifier la cl√© et charger les mod√®les">
                        <i class="fas fa-sync-alt"></i> Charger
                    </button>
                </div>
            </div>

            <div class="input-group hidden" id="model-group">
                <label>Mod√®le IA √† utiliser</label>
                <select id="model-select">
                    <option value="" disabled selected>Chargement...</option>
                </select>
            </div>

            <div class="file-drop" id="drop-area">
                <i class="fas fa-file-pdf"></i>
                <div id="file-label">Cliquez pour choisir votre CV (PDF)</div>
                <input type="file" id="cv-file" accept="application/pdf" style="display:none">
            </div>

            <button id="generate-btn" class="btn" disabled>
                <i class="fas fa-magic"></i> G√©n√©rer le Portfolio
            </button>
            
            <div id="status" class="status"></div>
            <a href="index.html" style="display:block; margin-top:20px; color:#999; text-decoration:none; font-size:0.85rem">Retour au site</a>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. CONFIGURATION
        // ==========================================
        const SUPABASE_URL = "https://ofjbztpsifilkptuhhit.supabase.co"; // ‚ö†Ô∏è REMPLACEZ ICI
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9mamJ6dHBzaWZpbGtwdHVoaGl0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzNjY4NzQsImV4cCI6MjA4Mzk0Mjg3NH0.NQDJYOPHYtQsP-XH3FVa_yYzenSzKfkO7iBu1q8dy8M"; // ‚ö†Ô∏è REMPLACEZ ICI
        
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        let user = null;
        let selectedFile = null;

        // ==========================================
        // 2. INITIALISATION
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('login-btn').addEventListener('click', login);
            document.getElementById('load-models-btn').addEventListener('click', fetchGeminiModels);
            document.getElementById('generate-btn').addEventListener('click', processCV);
            
            const dropArea = document.getElementById('drop-area');
            const fileInput = document.getElementById('cv-file');

            dropArea.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => handleFileSelect(e.target));

            // R√©cup√©rer cl√© locale
            const savedKey = localStorage.getItem('my_gemini_key');
            if (savedKey) {
                document.getElementById('gemini-key').value = savedKey;
                // On tente de charger les mod√®les automatiquement si la cl√© est l√†
                // fetchGeminiModels(); 
            }

            checkSession();
        });

        async function checkSession() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                user = session.user;
                showUploadSection();
            }
        }

        function showUploadSection() {
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('upload-section').classList.remove('hidden');
        }

        // ==========================================
        // 3. RECUPERER LES MOD√àLES GEMINI (NOUVEAU)
        // ==========================================
        async function fetchGeminiModels() {
            const apiKey = document.getElementById('gemini-key').value;
            const select = document.getElementById('model-select');
            const modelGroup = document.getElementById('model-group');
            const statusDiv = document.getElementById('status');
            
            if (!apiKey) return alert("Entrez une cl√© API d'abord.");
            
            statusDiv.innerHTML = "üîç Recherche des mod√®les disponibles...";
            statusDiv.className = "status";

            try {
                // On utilise v1beta car c'est l√† que sont les nouveaux mod√®les
                const url = `https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error.message);
                }

                const data = await response.json();
                
                // Vider la liste
                select.innerHTML = "";
                
                // Filtrer pour ne garder que ceux qui supportent "generateContent"
                const validModels = data.models.filter(m => 
                    m.supportedGenerationMethods && 
                    m.supportedGenerationMethods.includes("generateContent")
                );

                if (validModels.length === 0) throw new Error("Aucun mod√®le compatible trouv√©.");

                // Remplir le select
                validModels.forEach(model => {
                    const option = document.createElement("option");
                    // model.name ressemble √† "models/gemini-1.5-flash"
                    // On garde la valeur compl√®te pour l'URL plus tard
                    option.value = model.name; 
                    option.text = `${model.displayName} (${model.name.replace('models/', '')})`;
                    
                    // S√©lectionner par d√©faut le flash ou pro
                    if (model.name.includes("flash")) option.selected = true;
                    
                    select.appendChild(option);
                });

                modelGroup.classList.remove("hidden");
                statusDiv.innerHTML = "<span class='success'>‚úÖ Mod√®les charg√©s ! S√©lectionnez-en un.</span>";
                localStorage.setItem('my_gemini_key', apiKey);

            } catch (err) {
                console.error(err);
                statusDiv.innerHTML = `<span class="error">‚ùå Erreur Cl√© API : ${err.message}</span>`;
                modelGroup.classList.add("hidden");
            }
        }

        // ==========================================
        // 4. AUTH & UPLOAD
        // ==========================================
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
            if (error) alert("Erreur : " + error.message);
            else { user = data.user; showUploadSection(); }
        }

        function handleFileSelect(input) {
            if (input.files && input.files[0]) {
                selectedFile = input.files[0];
                document.getElementById('file-label').innerText = "üìÑ " + selectedFile.name;
                document.getElementById('file-label').style.fontWeight = "bold";
                document.getElementById('generate-btn').disabled = false;
            }
        }

        // ==========================================
        // 5. PROCESSUS PRINCIPAL
        // ==========================================
        async function processCV() {
            const apiKey = document.getElementById('gemini-key').value;
            // R√©cup√©rer le mod√®le choisi dans la liste
            const selectedModel = document.getElementById('model-select').value; 
            const statusDiv = document.getElementById('status');
            const btn = document.getElementById('generate-btn');
            
            if (!selectedModel) return alert("Veuillez charger et s√©lectionner un mod√®le IA.");
            if (!selectedFile) return alert("Veuillez choisir un fichier.");

            btn.disabled = true;
            statusDiv.className = "status";
            
            try {
                // 1. EXTRACTION
                statusDiv.innerText = "1/4 Extraction du texte...";
                const text = await extractTextFromPDF(selectedFile);
                
                // 2. ANALYSE (Avec le mod√®le choisi)
                statusDiv.innerText = `2/4 Analyse avec ${selectedModel.replace('models/', '')}...`;
                const jsonData = await analyzeWithGemini(text, apiKey, selectedModel);
                
                // 3. UPLOAD PDF
                statusDiv.innerText = "3/4 Upload du fichier...";
                const pdfUrl = await uploadPDFFile(selectedFile);
                if(pdfUrl) jsonData.personal.cvUrl = pdfUrl;

                // 4. SAUVEGARDE
                statusDiv.innerText = "4/4 Sauvegarde en base...";
                const { error } = await supabaseClient.from('portfolio').upsert({ id: 1, json_data: jsonData });
                if (error) throw error;

                statusDiv.innerHTML = "<span class='success'>‚úÖ Termin√© ! Redirection...</span>";
                setTimeout(() => window.location.href = 'index.html', 2000);

            } catch (err) {
                console.error(err);
                statusDiv.innerHTML = `<span class="error">‚ùå Erreur : ${err.message}</span>`;
                btn.disabled = false;
            }
        }

        // ==========================================
        // 6. HELPER FUNCTIONS
        // ==========================================
        async function extractTextFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let fullText = "";
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(" ");
                fullText += pageText + "\n";
            }
            return fullText;
        }

        async function analyzeWithGemini(text, apiKey, modelName) {
            const prompt = `
            Agis comme un expert RH. Extrais les donn√©es de ce CV en JSON strict.
            Structure:
            {
                "personal": { "name": "Pr√©nom Nom", "title": "Titre", "email": "", "phone": "", "location": "", "summary": "", "linkedin": "" },
                "softSkills": ["Skill1", "Skill2"],
                "languages": ["Langue1"],
                "education": [{ "degree": "", "school": "", "date": "" }],
                "experience": [{ "role": "", "company": "", "date": "", "tasks": ["Task1"] }],
                "techSkills": [{ "cat": "Categorie", "tools": "Outils" }],
                "projects": [{ "name": "", "desc": "", "tech": "" }],
                "certifications": [{ "name": "" }]
            }
            R√®gles: JSON uniquement. Pas de markdown.
            CV: ${text.substring(0, 30000)}`;

            // On utilise le nom du mod√®le s√©lectionn√© dynamiquement
            const url = `https://generativelanguage.googleapis.com/v1beta/${modelName}:generateContent?key=${apiKey}`;

            const response = await fetch(url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: { response_mime_type: "application/json" }
                })
            });

            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error.message);
            }

            const result = await response.json();
            const rawText = result.candidates[0].content.parts[0].text;
            return JSON.parse(rawText.replace(/```json/g, '').replace(/```/g, '').trim());
        }

        async function uploadPDFFile(file) {
            const fileName = `cv_${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
            const { data, error } = await supabaseClient.storage.from('uploads').upload(fileName, file);
            if (error) { console.warn("Upload fail", error); return null; }
            const { data: publicUrlData } = supabaseClient.storage.from('uploads').getPublicUrl(fileName);
            return publicUrlData.publicUrl;
        }

    </script>
</body>
</html>