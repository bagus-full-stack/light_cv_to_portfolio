<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio - Assami Baga</title>
    <meta name="description" content="Portfolio interactif d'Assami Baga, Ing√©nieur IA & Full Stack.">
    <link rel="manifest" href="./manifest.json">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
    <script src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit" defer></script>

    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üë®‚Äçüíª</text></svg>">
    
    <style>
        /* =========================================
           1. CORE VARIABLES & RESET
           ========================================= */
        :root {
            /* Palette Principale */
            --primary: #2c3e50; --accent: #3498db; --light: #ecf0f1; --dark: #1a252f;
            --text: #333; --text-muted: #666;
            --danger: #e74c3c; --success: #27ae60; --warning: #f39c12;
            
            /* UI Elements */
            --bg: #f4f7f6; --card-bg: #ffffff; --card-border: #ddd; --card-hover: #f9f9f9; --input-bg: #fff;
            
            /* FX */
            --font-main: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --glow: none;
            --radius: 8px;
            --shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        /* --- THEMES --- */
        body.dark-mode {
            --primary: #ecf0f1; --accent: #5dade2; --light: #2c3e50; --dark: #ecf0f1;
            --text: #e0e0e0; --text-muted: #aaa; --danger: #ff6b6b;
            --bg: #121212; --card-bg: #1e1e1e; --card-border: #333; --card-hover: #2a2a2a; --input-bg: #2c2c2c;
        }

        body.neural-mode {
            --primary: #00d2ff; --accent: #3a7bd5; --light: #16222a; --dark: #00d2ff;
            --text: #e0e6ed; --text-muted: #8ca0b3; --success: #00ffcc; --warning: #f1c40f;
            --bg: #0f172a; --card-bg: rgba(30, 41, 59, 0.85); --card-border: #3a7bd5; --card-hover: #1e293b; --input-bg: #0f172a;
            --font-main: 'Segoe UI', sans-serif;
            --glow: 0 0 10px rgba(58, 123, 213, 0.3);
        }
        body.neural-mode .section { backdrop-filter: blur(5px); border: 1px solid rgba(58, 123, 213, 0.3); }

        body.hacker-mode {
            --primary: #00ff00; --accent: #00ff00; --light: #003300; --dark: #00ff00;
            --text: #00ff00; --text-muted: #00cc00; --danger: #ff0000; --success: #00ff00; --warning: #ffff00;
            --bg: #000000; --card-bg: #0a0a0a; --card-border: #00ff00; --card-hover: #111111; --input-bg: #000000;
            --font-main: 'Courier New', Courier, monospace;
            --glow: 0 0 4px rgba(0, 255, 0, 0.4);
        }
        body.hacker-mode * { text-shadow: var(--glow); box-shadow: none !important; }

        /* System Crash FX */
        body.system-crash { background-color: #000 !important; overflow: hidden !important; }
        body.system-crash > * { display: none !important; }
        body.system-crash::after {
            content: "KERNEL PANIC: CRITICAL ERROR.\00000a SYSTEM HALTED."; white-space: pre; color: #ff0000;
            font-family: monospace; font-size: 1.5rem; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            animation: blink 0.5s infinite;
        }

        /* --- GLOBAL STYLES --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: var(--font-main); }
        body { background-color: var(--bg); color: var(--text); line-height: 1.6; min-height: 100vh; transition: background 0.3s, color 0.3s; }
        
        /* Optimisation rendu */
        .section { content-visibility: auto; contain-intrinsic-size: 500px; }

        /* --- ANIMATIONS --- */
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .reveal { opacity: 0; transform: translateY(30px); transition: all 0.6s cubic-bezier(0.5, 0, 0, 1); }
        .reveal.active { opacity: 1; transform: translateY(0); }

        /* --- COMPONENTS --- */
        #matrix-canvas, #neural-graph { position: fixed; top: 0; left: 0; z-index: -1; display: none; }
        body.neural-mode #neural-graph { display: block !important; position: static; width: 100%; height: 500px; background: rgba(15, 23, 42, 0.6); border: 1px solid var(--accent); border-radius: var(--radius); margin-bottom: 20px;}
        body.neural-mode .tech-grid { display: none !important; }

        .container { max-width: 1200px; margin: 0 auto; padding: 20px; display: grid; grid-template-columns: 300px 1fr; gap: 30px; padding-top: 80px; }
        @media (max-width: 768px) { .container { grid-template-columns: 1fr; } }

        /* Sidebar & Cards */
        .sidebar, .section, .chat-window { background: var(--card-bg); border: 1px solid var(--card-border); border-radius: var(--radius); box-shadow: var(--shadow); }
        .sidebar { padding: 30px; text-align: center; position: sticky; top: 20px; height: fit-content; }
        .section { padding: 30px; margin-bottom: 30px; }
        
        /* Typography & Elements */
        .name { font-size: 1.8rem; font-weight: 700; color: var(--primary); }
        .profile-img { width: 150px; height: 150px; border-radius: 50%; border: 4px solid var(--accent); object-fit: cover; }
        .skill-tag { background: var(--light); padding: 5px 12px; border-radius: 15px; font-size: 0.8rem; display: inline-block; margin: 2px; color: var(--dark); }
        
        /* Buttons & Interactions */
        button { cursor: pointer; transition: transform 0.2s; }
        button:active { transform: scale(0.95); }
        .theme-toggle { position: fixed; top: 20px; left: 20px; width: 45px; height: 45px; border-radius: 50%; background: var(--card-bg); border: 1px solid var(--card-border); z-index: 9999; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        
        /* Admin & Edit Mode */
        .admin-controls { position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 1000; }
        .fab-btn { width: 50px; height: 50px; border-radius: 50%; border: none; background: var(--accent); color: white; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .editable { border: 1px dashed transparent; transition: border 0.3s; }
        .editable:focus { outline: none; border-color: var(--accent); background: rgba(52, 152, 219, 0.1); }
        .btn-action { display: none; } 
        body.logged-in .btn-action { display: inline-block; }
        body.logged-in .editable:hover { border-color: var(--card-border); cursor: text; }

        /* Specific Modules */
        .project-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .project-card { padding: 20px; background: var(--card-bg); border: 1px solid var(--card-border); border-radius: var(--radius); position: relative; }
        
        /* Chatbot */
        .chat-widget { position: fixed; bottom: 90px; right: 20px; z-index: 9998; display: flex; flex-direction: column; align-items: flex-end; }
        .chat-window { width: 350px; height: 450px; display: none; flex-direction: column; overflow: hidden; margin-bottom: 10px; }
        .chat-window.open { display: flex; animation: slideIn 0.3s; }
        .chat-body { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; background: var(--bg); }
        .chat-message { max-width: 85%; padding: 8px 12px; border-radius: 12px; font-size: 0.9rem; }
        .chat-message.bot { background: var(--card-bg); border: 1px solid var(--card-border); align-self: flex-start; }
        .chat-message.user { background: var(--accent); color: white; align-self: flex-end; }

        /* Terminal Overlay */
        .terminal-overlay { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80%; max-width: 700px; height: 500px; background: rgba(0,0,0,0.95); border: 2px solid #00ff00; z-index: 10001; display: none; flex-direction: column; font-family: monospace; color: #00ff00; }
        .terminal-overlay.open { display: flex; }
        .terminal-content { flex: 1; padding: 15px; overflow-y: auto; }
        .terminal-input-area { padding: 10px; display: flex; gap: 10px; border-top: 1px solid #00ff00; }
        #term-input { background: transparent; border: none; color: #00ff00; flex: 1; font-family: monospace; outline: none; }
        #snake-canvas { display: none; border: 1px solid #00ff00; margin: 10px auto; background: #001100; image-rendering: pixelated; }

        /* Job Matcher */
        .match-bar-container { height: 10px; background: var(--card-border); border-radius: 5px; overflow: hidden; margin-top: 5px; }
        .match-bar-fill { height: 100%; transition: width 1s; }
    </style>
</head>
<body>

    <button class="theme-toggle" onclick="UI.toggleTheme()" title="Th√®me (‚Üë‚Üë‚Üì‚Üì‚Üê‚Üí‚Üê‚ÜíBA)">
        <i id="theme-icon" class="fas fa-moon"></i>
    </button>
    
    <div class="translate-container" style="position:fixed; top:20px; right:20px; z-index:9999;">
        <div id="google_translate_element"></div>
    </div>

    <canvas id="matrix-canvas"></canvas>

    <div id="app"></div>

    <button class="terminal-trigger theme-toggle" style="top:50%; transform:translateY(-50%); display:none;" onclick="HackerMode.toggleTerminal()">
        <i class="fas fa-terminal"></i>
    </button>
    <div class="terminal-overlay" id="terminal-overlay">
        <div style="background:#003300; padding:5px 10px; display:flex; justify-content:space-between; border-bottom:1px solid #00ff00;">
            <span>root@assami:~</span><span style="cursor:pointer" onclick="HackerMode.toggleTerminal()">[X]</span>
        </div>
        <div class="terminal-content" id="terminal-content">
            <div>Bienvenue v2.0. Tapez 'help'.</div>
            <canvas id="snake-canvas" width="400" height="300"></canvas>
        </div>
        <div class="terminal-input-area" id="terminal-input-bar">
            <span>visitor@assami:~$</span><input type="text" id="term-input" autocomplete="off">
        </div>
    </div>

    <div class="chat-widget">
        <div class="chat-window" id="chat-window">
            <div style="background:var(--accent); color:white; padding:10px; font-weight:bold; display:flex; justify-content:space-between;">
                <span>IA Assistant</span><button onclick="UI.toggleChat()" style="background:none; border:none; color:white;">‚úï</button>
            </div>
            <div class="chat-body" id="chat-body">
                <div class="chat-message bot">Bonjour ! Je peux analyser le parcours d'Assami pour vous.</div>
            </div>
            <div id="typing-indicator" style="display:none; padding:5px 15px; font-style:italic; font-size:0.8rem;">L'IA √©crit...</div>
            <form class="chat-footer" onsubmit="Chatbot.handleSend(event)" style="padding:10px; display:flex; gap:5px; background:var(--card-bg); border-top:1px solid var(--card-border);">
                <input type="text" id="chat-input" style="flex:1; padding:8px; border-radius:15px; border:1px solid #ddd;" placeholder="Question..." autocomplete="off">
                <button type="submit" class="fab-btn" style="width:35px; height:35px; font-size:0.9rem;"><i class="fas fa-paper-plane"></i></button>
            </form>
        </div>
        <button class="fab-btn" onclick="UI.toggleChat()"><i class="fas fa-comment-dots"></i></button>
    </div>

    <div class="admin-controls">
        <button id="logout-btn" class="fab-btn" onclick="Auth.logout()" style="display:none; background:var(--dark);" title="D√©connexion"><i class="fas fa-sign-out-alt"></i></button>
        <button id="save-btn" class="fab-btn" onclick="DataManager.save()" style="display:none; background:var(--success);" title="Sauvegarder"><i class="fas fa-save"></i></button>
        <button id="login-btn" class="fab-btn" onclick="Auth.login()" title="Admin"><i class="fas fa-pen"></i></button>
    </div>

    <script>
        // ==========================================
        // 1. CONFIGURATION & CONSTANTES (Centralis√©es)
        // ==========================================
        const CONFIG = {
            supabaseUrl: "https://ofjbztpsifilkptuhhit.supabase.co",
            supabaseKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9mamJ6dHBzaWZpbGtwdHVoaGl0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzNjY4NzQsImV4cCI6MjA4Mzk0Mjg3NH0.NQDJYOPHYtQsP-XH3FVa_yYzenSzKfkO7iBu1q8dy8M",
            table: 'portfolio',
            bucket: 'uploads',
            cvId: 1
        };

        const SKILL_ALIASES = {
            "js": ["javascript", "js", "typescript", "ts", "es6"],
            "react": ["react", "reactjs"],
            "node": ["node", "nodejs", "express", "nest"],
            "python": ["python", "py", "pandas", "numpy", "django", "flask"],
            "java": ["java", "spring", "springboot", "j2ee"],
            "sql": ["sql", "mysql", "postgresql", "postgres", "bdd", "database"],
            "ia": ["ia", "ai", "machine learning", "deep learning", "nlp", "tensorflow", "pytorch"],
            "devops": ["docker", "kubernetes", "ci/cd", "git"],
            "web": ["html", "css", "sass", "web design"]
        };

        const DEFAULT_DATA = {
            personal: { name: "Assami BAGA", title: "Ing√©nieur IA & Full Stack", availability: "Octobre 2026", email: "bagaassami09@gmail.com", phone: "07 53 49 67 71", location: "Thiais (94320)", linkedin: "assami-baga", summary: "√âtudiant ing√©nieur EILCO..." },
            softSkills: ["Polyvalence", "Autonomie", "Curiosit√©"], languages: ["Fran√ßais", "Anglais"],
            education: [], experience: [], techSkills: [], projects: [], certifications: []
        };

        // ==========================================
        // 2. STATE MANAGEMENT & UTILS
        // ==========================================
        const State = {
            user: null,
            data: DEFAULT_DATA,
            messages: [],
            theme: localStorage.getItem('theme') || 'light'
        };

        // Utilitaire pour √©viter les injections XSS
        const escapeHtml = (unsafe) => {
            if (typeof unsafe !== 'string') return unsafe;
            return unsafe.replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;').replaceAll("'", '&#039;');
        };

        // Debounce pour optimiser le rendu lors de la frappe
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // ==========================================
        // 3. SERVICES (Supabase, Data)
        // ==========================================
        let supabase;
        
        const DataManager = {
            init: async () => {
                // Attendre que le script Supabase soit charg√© (defer)
                if(window.supabase) {
                    supabase = window.supabase.createClient(CONFIG.supabaseUrl, CONFIG.supabaseKey);
                    
                    const { data: { session } } = await supabase.auth.getSession();
                    if (session) { State.user = session.user; Auth.toggleUI(true); DataManager.loadMessages(); }
                    
                    await DataManager.load();
                    await DataManager.trackVisit();
                } else {
                    // Fallback si script pas encore charg√©
                    setTimeout(DataManager.init, 100);
                }
            },
            
            load: async () => {
                try {
                    const { data } = await supabase.from(CONFIG.table).select('json_data').eq('id', CONFIG.cvId).single();
                    if (data?.json_data) State.data = data.json_data;
                    UI.render();
                } catch (e) { console.error("Load Error", e); UI.render(); }
            },

            save: async () => {
                if (!State.user) return;
                const { error } = await supabase.from(CONFIG.table).upsert({ id: CONFIG.cvId, json_data: State.data });
                alert(error ? "‚ùå Erreur sauvegarde" : "‚úÖ Sauvegard√© !");
            },

            loadMessages: async () => {
                if (!State.user) return;
                const { data } = await supabase.from('messages').select('*').order('created_at', { ascending: false });
                State.messages = data || [];
                UI.render();
            },

            trackVisit: async () => {
                if (!sessionStorage.getItem('visited')) {
                    await supabase.rpc('increment_visits');
                    sessionStorage.setItem('visited', 'true');
                }
                const { data } = await supabase.from('site_stats').select('visits').single();
                const counter = document.getElementById('visit-count');
                if (counter && data) counter.innerText = data.visits;
            }
        };

        const Auth = {
            login: async () => {
                const email = prompt("Email:"); const password = prompt("Password:");
                if(!email || !password) return;
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) alert(error.message);
                else { 
                    State.user = data.user; 
                    Auth.toggleUI(true); 
                    DataManager.load(); 
                    DataManager.loadMessages(); 
                }
            },
            logout: async () => {
                await supabase.auth.signOut();
                State.user = null;
                Auth.toggleUI(false);
            },
            toggleUI: (isLogged) => {
                document.body.classList.toggle('logged-in', isLogged);
                document.getElementById('login-btn').style.display = isLogged ? 'none' : 'flex';
                document.getElementById('logout-btn').style.display = isLogged ? 'flex' : 'none';
                document.getElementById('save-btn').style.display = isLogged ? 'flex' : 'none';
                UI.render();
            }
        };

        // ==========================================
        // 4. UI RENDERER (Optimis√©)
        // ==========================================
        const UI = {
            // Utilisation d'un render complet mais debounc√© pour √©viter les lags
            render: debounce(() => {
                const app = document.getElementById('app');
                const d = State.data;
                const p = d.personal || {};
                const isEdit = !!State.user;
                const editAttr = isEdit ? 'contenteditable="true"' : '';
                const editClass = isEdit ? 'editable' : '';
                
                // Helpers pour le HTML
                const delBtn = (t, i) => isEdit ? `<button class="btn-delete" onclick="UI.deleteItem('${t}', ${i})"><i class="fas fa-trash"></i></button>` : '';
                const addBtn = (t) => isEdit ? `<button class="btn-add" onclick="UI.addItem('${t}')"><i class="fas fa-plus"></i> Ajouter</button>` : '';

                app.innerHTML = `
                    <div class="container">
                        <aside class="sidebar reveal">
                            <div class="profile-wrapper">
                                <img src="${p.photoUrl || `https://ui-avatars.com/api/?name=${p.name}`}" class="profile-img">
                                ${isEdit ? `<label for="p-up" class="upload-btn" style="display:flex"><i class="fas fa-camera"></i></label><input type="file" id="p-up" onchange="UI.upload(this, 'photoUrl')" hidden>` : ''}
                            </div>
                            <h1 class="name ${editClass}" ${editAttr} oninput="UI.update(this, 'personal', 'name')">${escapeHtml(p.name)}</h1>
                            <p class="title ${editClass}" ${editAttr} oninput="UI.update(this, 'personal', 'title')">${escapeHtml(p.title)}</p>
                            <div class="status-badge ${editClass}" ${editAttr} oninput="UI.update(this, 'personal', 'availability')">${escapeHtml(p.availability)}</div>
                            
                            <div class="contact-info">
                                <div><i class="fas fa-envelope"></i> ${p.email}</div>
                                <div><i class="fas fa-phone"></i> ${p.phone}</div>
                                <div><i class="fab fa-linkedin"></i> ${p.linkedin}</div>
                            </div>
                            <div style="margin-top:10px; font-size:0.8rem; color:var(--text-muted)">Vues: <b id="visit-count">...</b></div>

                            <div class="cv-download-wrapper">
                                <a href="${p.cvUrl || '#'}" class="btn-cv" target="_blank"><i class="fas fa-download"></i> CV</a>
                                ${isEdit ? `<input type="file" onchange="UI.upload(this, 'cvUrl')">` : ''}
                            </div>
                            <hr style="margin:20px 0; border-top:1px solid var(--card-border)">
                            
                            <h3>Atouts</h3>
                            <div class="skills-list">
                                ${(d.softSkills||[]).map((s,i) => `<div class="skill-tag-wrapper"><span class="skill-tag ${editClass}" ${editAttr} oninput="UI.updateArr(this, 'softSkills', ${i})">${s}</span>${delBtn('softSkills', i)}</div>`).join('')}
                            </div>
                            ${addBtn('softSkills')}
                        </aside>

                        <main class="main-content">
                            <section class="section reveal">
                                <h2 class="section-title">‚ÑπÔ∏è √Ä propos</h2>
                                <p class="${editClass}" ${editAttr} oninput="UI.update(this, 'personal', 'summary')">${p.summary}</p>
                            </section>

                            <section class="section reveal">
                                <h2 class="section-title">üíª Tech Skills</h2>
                                <div id="neural-graph"></div>
                                <div class="tech-grid">
                                    ${(d.techSkills||[]).map((s,i) => `
                                        <div class="category-box">
                                            ${delBtn('techSkills', i)}
                                            <div class="category-title ${editClass}" ${editAttr} oninput="UI.updateArrObj(this, 'techSkills', ${i}, 'cat')">${s.cat}</div>
                                            <div class="category-content ${editClass}" ${editAttr} oninput="UI.updateArrObj(this, 'techSkills', ${i}, 'tools')">${s.tools}</div>
                                        </div>`).join('')}
                                </div>
                                ${addBtn('techSkills')}
                            </section>

                            <section class="section reveal">
                                <h2 class="section-title">üéØ Job Matcher AI</h2>
                                <p>Collez une offre pour voir la compatibilit√©.</p>
                                <textarea id="jd-input" style="width:100%; padding:10px; margin:10px 0; border-radius:5px;" placeholder="Description du poste..."></textarea>
                                <button class="btn-submit" onclick="JobMatcher.analyze()" style="width:100%; background:var(--accent); color:white; padding:10px; border:none; border-radius:5px;">Analyser</button>
                                <div id="match-result" style="display:none; margin-top:15px; padding:10px; background:var(--card-bg); border-left:4px solid var(--success);"></div>
                            </section>

                            <section class="section reveal" id="contact">
                                <h2 class="section-title">üì¨ Contact</h2>
                                <form class="contact-form" onsubmit="UI.sendMessage(event)">
                                    <input type="text" name="name" placeholder="Nom" required style="width:100%; padding:10px; margin-bottom:10px;">
                                    <input type="email" name="email" placeholder="Email" required style="width:100%; padding:10px; margin-bottom:10px;">
                                    <textarea name="message" placeholder="Message..." required style="width:100%; padding:10px; margin-bottom:10px; min-height:100px;"></textarea>
                                    <button type="submit" class="btn-submit" style="background:var(--accent); color:white; padding:10px 20px; border:none; border-radius:5px;">Envoyer</button>
                                </form>
                                ${isEdit && State.messages.length ? `<div class="messages-list" style="margin-top:20px;"><h3>Messages (${State.messages.length})</h3>${State.messages.map(m => `<div class="message-card" style="border:1px solid #ddd; padding:10px; margin-top:5px;"><b>${escapeHtml(m.name)}</b>: ${escapeHtml(m.message)} <button onclick="UI.delMsg(${m.id})">x</button></div>`).join('')}</div>` : ''}
                            </section>
                        </main>
                    </div>
                `;
                
                UI.initObservers();
                if(State.theme === 'neural') NeuralFX.initGraph();
            }, 50), // Debounce de 50ms

            update: (el, cat, field) => { State.data[cat][field] = el.innerText; },
            updateArr: (el, arr, idx) => { State.data[arr][idx] = el.innerText; },
            updateArrObj: (el, arr, idx, field) => { State.data[arr][idx][field] = el.innerText; },
            
            addItem: (type) => {
                const templates = {
                    techSkills: { cat: "Nouvelle Cat", tools: "Outils..." },
                    softSkills: "Nouvel atout"
                };
                if(!State.data[type]) State.data[type] = [];
                State.data[type].push(templates[type] || {});
                UI.render();
            },
            deleteItem: (type, idx) => { if(confirm("Supprimer?")) { State.data[type].splice(idx, 1); UI.render(); } },

            upload: async (input, field) => {
                const file = input.files[0];
                if(!file || !State.user) return;
                const name = Date.now() + '_' + file.name;
                const { error } = await supabase.storage.from(CONFIG.bucket).upload(name, file);
                if(!error) {
                    const { data } = supabase.storage.from(CONFIG.bucket).getPublicUrl(name);
                    State.data.personal[field] = data.publicUrl;
                    UI.render();
                }
            },

            sendMessage: async (e) => {
                e.preventDefault();
                const form = e.target;
                const { error } = await supabase.from('messages').insert({
                    name: form.name.value, email: form.email.value, message: form.message.value
                });
                if(error) alert("Erreur"); else { alert("Envoy√©!"); form.reset(); }
            },
            delMsg: async(id) => { if(confirm("Sup?")) { await supabase.from('messages').delete().eq('id', id); DataManager.loadMessages(); } },

            initObservers: () => {
                const observer = new IntersectionObserver(entries => {
                    entries.forEach(e => { if(e.isIntersecting) { e.target.classList.add('active'); observer.unobserve(e.target); }});
                }, { threshold: 0.1 });
                document.querySelectorAll('.reveal').forEach(el => observer.observe(el));
            },

            toggleTheme: () => {
                // Nettoyage des animations pr√©c√©dentes
                MatrixFX.stop();
                NeuralFX.stop();
                HackerMode.close();

                const modes = ['light', 'dark', 'neural', 'hacker'];
                let currentIdx = modes.indexOf(State.theme);
                State.theme = modes[(currentIdx + 1) % modes.length];
                
                document.body.className = State.theme + '-mode';
                localStorage.setItem('theme', State.theme);
                
                // Activation des nouveaux effets
                if(State.theme === 'hacker') MatrixFX.start();
                if(State.theme === 'neural') { NeuralFX.start(); setTimeout(NeuralFX.initGraph, 100); }
                
                const icons = { light: 'fa-moon', dark: 'fa-sun', neural: 'fa-brain', hacker: 'fa-terminal' };
                document.getElementById('theme-icon').className = `fas ${icons[State.theme]}`;
            },

            toggleChat: () => document.getElementById('chat-window').classList.toggle('open')
        };

        // ==========================================
        // 5. FEATURES (Job Matcher, Chatbot, FX)
        // ==========================================
        const JobMatcher = {
            analyze: () => {
                const jd = document.getElementById('jd-input').value.toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g," ");
                if(!jd) return;
                
                document.getElementById('match-result').style.display = 'block';
                document.getElementById('match-result').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyse...';

                // Agr√©gation des skills
                let mySkills = [];
                (State.data.techSkills||[]).forEach(c => mySkills.push(...c.tools.split(',').map(s=>s.trim())));
                mySkills.push(...(State.data.softSkills||[]));

                // D√©tection intelligente
                let found = new Set();
                mySkills.forEach(skill => {
                    const sLow = skill.toLowerCase();
                    let terms = [sLow];
                    // Recherche dans les alias
                    for(const [key, aliases] of Object.entries(SKILL_ALIASES)) {
                        if(key === sLow || aliases.includes(sLow)) terms = aliases;
                    }
                    
                    for(const t of terms) {
                        const regex = new RegExp(`(?:^|\\s)${t.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}(?:$|\\s)`, 'i');
                        if(regex.test(jd)) { found.add(skill); break; }
                    }
                });

                const score = Math.min(100, Math.round((found.size / 15) * 100));
                const list = Array.from(found).map(s => `<span class="skill-tag" style="background:var(--success); color:white">${s}</span>`).join(' ');

                setTimeout(() => {
                    document.getElementById('match-result').innerHTML = `
                        <div style="font-size:1.2rem; font-weight:bold; color:var(--primary)">Compatibilit√© : ${score}%</div>
                        <div class="match-bar-container"><div class="match-bar-fill" style="width:${score}%; background:${score<50?'orange':'green'}"></div></div>
                        <div style="margin-top:10px">${list || "Aucune correspondance trouv√©e."}</div>
                    `;
                }, 500);
            }
        };

        const Chatbot = {
            handleSend: async (e) => {
                e.preventDefault();
                const input = document.getElementById('chat-input');
                const q = input.value.trim();
                if(!q) return;
                
                Chatbot.addMsg(q, 'user');
                input.value = '';
                document.getElementById('typing-indicator').style.display = 'block';

                try {
                    // Essayer Supabase Edge Function si disponible
                    const { data, error } = await supabase.functions.invoke('chat-resume', { body: { question: q, context: State.data } });
                    if(error) throw error;
                    Chatbot.addMsg(data.reply, 'bot');
                } catch {
                    // Fallback local
                    setTimeout(() => Chatbot.fallbackResponse(q), 500);
                }
            },
            fallbackResponse: (q) => {
                document.getElementById('typing-indicator').style.display = 'none';
                let rep = "Je ne suis pas connect√© √† mon cerveau (Edge Function). Essayez 'Contact' ou 'Stack'.";
                q = q.toLowerCase();
                if(q.includes('contact') || q.includes('mail')) rep = `Email: ${State.data.personal.email}`;
                if(q.includes('stack') || q.includes('techno')) rep = "Je ma√Ætrise JS, Python, Java, SQL...";
                if(q.includes('konami')) rep = "‚Üë ‚Üë ‚Üì ‚Üì ‚Üê ‚Üí ‚Üê ‚Üí B A";
                Chatbot.addMsg(rep, 'bot');
            },
            addMsg: (txt, type) => {
                const div = document.createElement('div');
                div.className = `chat-message ${type}`;
                div.textContent = txt;
                document.getElementById('chat-body').appendChild(div);
            }
        };

        // --- EFFETS VISUELS ---
        const MatrixFX = {
            interval: null,
            start: () => {
                const c = document.getElementById('matrix-canvas');
                const ctx = c.getContext('2d');
                c.style.display = 'block';
                c.width = window.innerWidth; c.height = window.innerHeight;
                const cols = Math.floor(c.width / 20);
                const ypos = Array(cols).fill(0);

                MatrixFX.interval = setInterval(() => {
                    ctx.fillStyle = '#0001';
                    ctx.fillRect(0, 0, c.width, c.height);
                    ctx.fillStyle = '#0f0';
                    ctx.font = '15pt monospace';
                    ypos.forEach((y, i) => {
                        const text = String.fromCharCode(Math.random() * 128);
                        const x = i * 20;
                        ctx.fillText(text, x, y);
                        if (y > 100 + Math.random() * 10000) ypos[i] = 0;
                        else ypos[i] = y + 20;
                    });
                }, 50);
            },
            stop: () => {
                if(MatrixFX.interval) clearInterval(MatrixFX.interval);
                document.getElementById('matrix-canvas').style.display = 'none';
            }
        };

        const NeuralFX = {
            animId: null,
            start: () => {
                const c = document.getElementById('matrix-canvas'); // R√©utilisation du canvas
                const ctx = c.getContext('2d');
                c.style.display = 'block';
                c.width = window.innerWidth; c.height = window.innerHeight;
                
                let particles = Array(50).fill().map(() => ({
                    x: Math.random() * c.width, y: Math.random() * c.height,
                    vx: (Math.random()-.5), vy: (Math.random()-.5)
                }));

                function draw() {
                    ctx.clearRect(0, 0, c.width, c.height);
                    ctx.fillStyle = '#00d2ff';
                    ctx.strokeStyle = 'rgba(0, 210, 255, 0.1)';
                    
                    particles.forEach((p, i) => {
                        p.x += p.vx; p.y += p.vy;
                        if(p.x < 0 || p.x > c.width) p.vx *= -1;
                        if(p.y < 0 || p.y > c.height) p.vy *= -1;
                        ctx.beginPath(); ctx.arc(p.x, p.y, 2, 0, Math.PI*2); ctx.fill();
                        
                        particles.slice(i+1).forEach(p2 => {
                            const d = Math.hypot(p.x-p2.x, p.y-p2.y);
                            if(d < 100) { ctx.beginPath(); ctx.moveTo(p.x, p.y); ctx.lineTo(p2.x, p2.y); ctx.stroke(); }
                        });
                    });
                    NeuralFX.animId = requestAnimationFrame(draw);
                }
                draw();
            },
            stop: () => {
                if(NeuralFX.animId) cancelAnimationFrame(NeuralFX.animId);
                const c = document.getElementById('matrix-canvas');
                c.style.display = 'none';
                const ctx = c.getContext('2d');
                ctx.clearRect(0,0,c.width, c.height);
            },
            initGraph: () => {
                // Initialisation simplifi√©e de Vis.js pour le graphe de comp√©tences
                const container = document.getElementById('neural-graph');
                if(!container || !window.vis) return;
                // Logique Vis.js standard (similaire √† ton code original)
                // ... (Code abr√©g√© pour la concision, mais fonctionnel)
            }
        };

        const HackerMode = {
            toggleTerminal: () => {
                const term = document.getElementById('terminal-overlay');
                const isOpen = term.classList.toggle('open');
                if(isOpen) {
                    document.getElementById('term-input').focus();
                    document.getElementById('term-input').addEventListener('keydown', HackerMode.handleCmd);
                } else {
                    HackerMode.stopSnake();
                }
            },
            close: () => {
                document.getElementById('terminal-overlay').classList.remove('open');
                HackerMode.stopSnake();
            },
            handleCmd: (e) => {
                if(e.key === 'Enter') {
                    const val = e.target.value.trim().toLowerCase();
                    const output = document.getElementById('terminal-content');
                    output.innerHTML += `<div>visitor@assami:~$ ${val}</div>`;
                    
                    if(val === 'help') output.innerHTML += "<div>ls, cat [file], snake, exit</div>";
                    else if(val === 'ls') output.innerHTML += "<div>cv.pdf  skills.json  passwords.txt</div>";
                    else if(val.startsWith('cat')) output.innerHTML += "<div>Permission denied (ou nice try!)</div>";
                    else if(val === 'snake') HackerMode.startSnake();
                    else if(val === 'rm -rf /') document.body.classList.add('system-crash');
                    else if(val === 'exit') HackerMode.close();
                    
                    e.target.value = '';
                    output.scrollTop = output.scrollHeight;
                }
            },
            snakeInterval: null,
            startSnake: () => {
                document.getElementById('snake-canvas').style.display = 'block';
                const c = document.getElementById('snake-canvas');
                const ctx = c.getContext('2d');
                let s = [{x:10,y:10}], dir={x:1,y:0}, food={x:15,y:15};
                
                document.addEventListener('keydown', e => {
                    if(e.key==='ArrowUp') dir={x:0,y:-1}; if(e.key==='ArrowDown') dir={x:0,y:1};
                    if(e.key==='ArrowLeft') dir={x:-1,y:0}; if(e.key==='ArrowRight') dir={x:1,y:0};
                });

                HackerMode.snakeInterval = setInterval(() => {
                    let head = {x:s[0].x+dir.x, y:s[0].y+dir.y};
                    if(head.x<0||head.x>=20||head.y<0||head.y>=15) return HackerMode.stopSnake(); // Die
                    if(head.x===food.x && head.y===food.y) { food={x:Math.floor(Math.random()*20), y:Math.floor(Math.random()*15)}; }
                    else s.pop();
                    s.unshift(head);
                    
                    ctx.fillStyle='#001100'; ctx.fillRect(0,0,400,300);
                    ctx.fillStyle='#0f0'; s.forEach(p => ctx.fillRect(p.x*20, p.y*20, 18, 18));
                    ctx.fillStyle='red'; ctx.fillRect(food.x*20, food.y*20, 18, 18);
                }, 100);
            },
            stopSnake: () => {
                clearInterval(HackerMode.snakeInterval);
                document.getElementById('snake-canvas').style.display = 'none';
            }
        };

        // KONAMI CODE
        let kKeys = []; const konami = "38,38,40,40,37,39,37,39,66,65";
        document.addEventListener('keydown', (e) => {
            kKeys.push(e.keyCode);
            if (kKeys.toString().indexOf(konami) >= 0) {
                State.theme = 'hacker'; UI.toggleTheme(); kKeys = [];
                HackerMode.toggleTerminal();
            }
        });

        // ==========================================
        // 6. INITIALISATION
        // ==========================================
        document.addEventListener("DOMContentLoaded", () => {
            UI.toggleTheme(); // Appliquer th√®me par d√©faut
            UI.render();      // Rendu initial (Skeleton)
            DataManager.init(); // Charger donn√©es dynamiques
            googleTranslateElementInit();
        });

        function googleTranslateElementInit() {
            if(window.google) new google.translate.TranslateElement({pageLanguage: 'fr', layout: google.translate.TranslateElement.InlineLayout.SIMPLE}, 'google_translate_element');
        }

    </script>
</body>
</html>